<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Contact Manager</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/handlebars.js/4.0.5/handlebars.js"></script>
  <script src="underscore.js"></script>
  <style>
    body {
      background-color: white;
      width: 100%;
      height: 100%;
    }

    #add_search {
      text-align: center;
      margin: auto;
    }

    header {
      height: 75px;
      width: 100%;
      background-color: #cdbfe3;
      color: white;
      text-align: center;
      padding: 5px;
    }

    #add_search {
      background-color: #ededed;
      padding: 30px;
      display: flex;
      justify-content: space-around;
    }

    .add_btn {
      height: 75px;
      padding: 15px;
      font-size: 24px;
      border-radius: 5px;
      background-color: gray;
      border: 1px solid blue
    }

    #search {
      padding: 15px;
      border-radius: 5px;
      border: 1px solid lightgray;
      font-size: 20px;
    }

    #list {
      text-align: center;
    }

    .form_div {
      width: 50%;
    }

    .form_div,
    .create_div,
    .edit_div {
      /*display: none;*/
      visibility: hidden;
    }

    .show {
      /*display: block;*/
      visibility: visible;
      opacity: 1;
      transition: visibility 0s linear 0s, opacity 800ms;
    }

    .hide {
      /*display: none;*/
      visibility: hidden;
      opacity: 0;
      /*transition: visibility 0s linear 800ms, opacity 800ms;*/
    }

    #list_populated {
      display: none;
      height: auto;
      width: 350px;
    }

    .item_wrapper {
      border-bottom: 1px solid lightgray;
      padding-bottom: 20px;
      line-height: 8px;
    }

    #all_tags {
      display: none;
      margin: 15px 0 10px 50px;
    }

    #list_initial {
      width: 75%;
      background-color: lightgray;
      text-align: center;
      padding: 15px;
      margin: 25px auto;
    }

    button:hover {
      background-color: burlywood;
    }
  </style>
</head>

<body>
  <header>
    <h1>Contact Manager</h1>
  </header>

  <div id='underlay_wrapper'>
    <div id="add_search">
      <button class="add_btn">Add Contact</button>
      <input type="text" name="search" id="search" placeholder="Search">
    </div>
    <div id="list_initial">
      <h2>No contacts</h2>
      <button class="add_btn">Add Contact</button>
    </div>
    <button id='all_tags'>All Contacts</button>
    <div id="list_populated">
    </div>
  </div>

  <div id="form_div" class='form_div'>
    <div id="create_div" class="create_div">
      <h1>Create Contact</h1>
      <form action="/api/contacts" method="post">
        <fieldset>
          <dl>
            <dt><label for="full_name">Full name:</label></dt>
            <dd><input type="text" name="full_name" id="full_name" required pattern="[A-Za-z]*"></dd>
            <dt><label for="email">Email address:</label></dt>
            <dd><input type="email" name="email" id="email"></dd>
            <dt> <label for="phone_number">Telephone number:</label></dt>
            <dd><input type="text" name="phone_number" id="phone_number" pattern="\d{3}-\d{3}-\d{4}"
                placeholder="###-###-####"></dd>
            <dt> <label for="tagsSelect">Tags:</label></dt>
            <dd><select multiple name="tags" id="tagsSelect">
                <option value=""></option>
                <option value="sales">Sales</option>
                <option value="engineering">Engineering</option>
                <option value="marketing">Marketing</option>
              </select></dd>
          </dl>
          <input type="submit" value="Submit" class="submit">
          <button class='cancel'>Cancel</button>
        </fieldset>
      </form>
    </div>
    <div id="edit_div" class="edit_div"></div>
  </div>


  <script id='edit_form_template' type="text/x-handlebars-template">
    <h1>Edit Contact</h1>
    <form action="#" id="{{contact.id}}">
      <fieldset>
        <dl>
          <dt><label for="full_name">Full name:</label></dt>
          <dd><input type="text" name="full_name"  id="full_name" value="{{contact.full_name}}" required pattern="[A-Za-z]*"></dd>
          <dt><label for="email">Email address:</label></dt>
          <dd><input type="email" name="email" id="email" value="{{contact.email}}"></dd>
          <dt> <label for="phone_number">Telephone number:</label></dt>
          <dd><input type="text" name="phone_number" id="phone_number" value="{{contact.phone_number}}" pattern="\d{3}-\d{3}-\d{4}" placeholder="###-###-####" ></dd>
          <dt> <label for="tags">Tags:</label></dt>
          <dd><select multiple name="tags" id="tags">
            {
              <option value="sales" id="salesSelect" {{func contact.tags "sales"}}>Sales</option>
              <option value="engineering" id="engineeringSelect" {{func contact.tags "engineering"}} >Engineering</option>
              <option value="marketing" id="marketingSelect" {{func contact.tags "marketing"}}>Marketing</option>


            </select></dd>
        </dl>
        <input type="submit" value="Submit" class="submit">
        <button class='cancel'>Cancel</button>
      </fieldset>
    </form>
  </div>
  </script>

  <script id="list_template" type="text/x-handlebars-template">
    <div id="list_wrapper">
      {{#each array}}
      <div class="item_wrapper" id={{id}}>
        <h2> <strong> {{full_name}}</strong></h2>
        <br>
        <p> <strong>Phone Number:</strong> </p>
        <p>{{phone_number}}</p>
        <p> <strong>Email:</strong> </p>
        <p>{{email}}</p>
        <p class='tags_area'> <strong>Tags:</strong>
          {{#if tags}}
          {{#tags}}
          <button class='tag'>{{.}}</button>
          {{/tags}}
          {{/if}}
        </p>
        <br>
        <button class="edit">Edit</button>
        <button class="delete">Delete</button>
      </div>
      {{/each}}
    </div>
  </script>

  <script>
    Handlebars.registerHelper('func', function (list, name) {
      if (list) {
        if (list.includes(name)) {
          return 'selected';
        }
      }
      //return !list ? null : list.includes(name) ? 'selected' : null
    })

    document.addEventListener('DOMContentLoaded', () => {
      let App = {

        handleAdd() {
          this.showElm(this.form_div)
          //console.log(this.form_div)
          //this.form_div.style.display = 'block';
          //this.form_div.classList.add('show')
          this.showElm(document.querySelector('.create_div'))
          //document.querySelector('.create_div').style.display = 'block';
          //document.querySelector('.create_div').classList.add('show')

          this.hideElm(document.querySelector('.edit_div'))
          //document.querySelector('.edit_div').style.display = 'none';
          //document.querySelector('.edit_div').classList.add('hide')

          document.querySelector('#underlay_wrapper').style.display = "none";
        },
        handleCancel(e) {
          e.preventDefault()
          this.hideElm(this.form_div)
          //this.form_div.style.display = 'none';
          //this.form_div.classList.add('hide')
          document.querySelector('.create_div').style.display = 'block'
          document.querySelector('#underlay_wrapper').style.display = "block";
        },

        hideElm(node) {
          node.classList.add('hide')
          node.classList.remove('show')
        },
        showElm(node) {
          node.classList.add('show')
          node.classList.remove('hide')
        },

        handleEditButton(contactId) {
          let editedContact = this.contacts.find(elm => elm.id === Number(contactId));
          //let editedContact = this.contacts.filter(elm => elm.id === Number(contactId))[0];
          this.showElm(this.form_div)
          //this.form_div.style.display = 'block';
          //this.form_div.classList.add('show');
          //this.hideElm(document.querySelector('.create_div'))
          document.querySelector('.create_div').style.display = 'none';
          //document.querySelector('.create_div').classList.add('hide')

          this.showElm(document.querySelector('#edit_div'))
          //document.querySelector('#edit_div').style.display = 'block';
          //document.querySelector('.edit_div').classList.add('show')

          document.querySelector('#underlay_wrapper').style.display = "none";
          document.querySelector('#edit_div').innerHTML = '';
          document.querySelector('#edit_div').innerHTML = this.edit_template({ contact: editedContact })
        },

        handleSubmitNew(e) {
          e.preventDefault();
          let formData = new FormData(this.form_new);
          this.form_new.reset();
          //let newcontact = this.formDataToJson(formData);
          let json = JSON.stringify(this.formDataToJson(formData));

          let xhr = new XMLHttpRequest();
          xhr.open('POST', '/api/contacts');
          xhr.setRequestHeader('Content-Type', 'application/json');
          xhr.addEventListener('load', () => {
            //document.querySelector('.create_div').style.display = 'block';
            this.showElm(document.querySelector('.create_div'))
            this.hideElm(this.form_div)

            //this.form_div.classList.add('hide')
            //this.form_div.style.display = 'none';

            //if (this.contacts.length > 0) {....or if POST request was successful
            this.retrieveList();
            this.success();
            //}
            document.querySelector('#underlay_wrapper').style.display = "block";
          })
          xhr.send(json);
        },
        handleSubmitEdit(e, id) {
          e.preventDefault();

          let formData = new FormData(document.querySelector('#edit_div form'));
          let json = JSON.stringify(this.formDataToJson(formData));

          let xhr = new XMLHttpRequest();
          xhr.open('PUT', `/api/contacts/${id}`);
          xhr.setRequestHeader('Content-Type', 'application/json');
          xhr.send(json);
          xhr.addEventListener('load', () => {
            //should i check for successful response? either by investigatng response or by statuscode. status code is not as thorough
            document.querySelector('.create_div').style.display = 'block';
            this.hideElm(this.form_div);
            //this.form_div.classList.add('hide')
            //this.form_div.style.display = 'none';

            //check in case submission wasnt successful. When would it not be successful? Can contacts list ever be 0 after a submit edit? No...
            if (this.contacts.length > 0) {
              this.retrieveList();
              this.success();
            }
            document.querySelector('#underlay_wrapper').style.display = "block";
          })
        },
        handleDelete(contactId) {
          if (confirm('Are you sure you want to delete?')) {
            let xhr = new XMLHttpRequest();
            xhr.open('DELETE', `/api/contacts/${contactId}`);
            xhr.send();
            //check for successful operation and if so post text node saying deletion successful
            xhr.addEventListener('loadend', () => {
              this.retrieveList();
            })
          }
        },
        retrieveList() {
          this.search.value = '';
          let xhr = new XMLHttpRequest();
          xhr.open('get', '/api/contacts');
          xhr.send();
          xhr.responseType = 'json';
          xhr.addEventListener('load', e => {
            this.contacts = xhr.response;
            //need to convert the tags prop string to array so Handlebars template can loop through. In case there are no tags there should be no buttons - was seeing a small empty tags button appear, I think it's because of an empty string value so setting it to 'null'
            this.contacts.forEach(obj => {
              if (typeof obj.tags === 'string') {
                obj.tags = obj.tags.split(',');
              }
              if (!obj.tags[0]) obj.tags = null;
            })
            if (this.contacts.length > 0) {
              this.renderList(this.contacts);
            } else {
              this.initial.style.display = 'block';
              this.fullList.innerHTML = '';

              document.querySelector('#all_tags').style.display = 'none';
            }
          })
        },
        handleListClick(e) {
          if (e.target.tagName === 'BUTTON') {
            if (e.target.classList.contains('edit')) {
              this.handleEditButton(e.target.parentNode.id);
            } else if (e.target.classList.contains('delete')) {
              this.handleDelete(e.target.parentNode.id);
            } else if (e.target.classList.contains('tag')) {
              this.renderTagList(e);
            }
          }
        },
        handleSearch(e) {
          e.preventDefault()
          console.log(this.search.value)
          console.log(this.search.value.trim())
          //this.initial.style.display = 'none';
          //if (this.search.value.trim()) {
          //this.searchQuery = this.search.value;
          this.searchList = [];
          if (this.search.value) {
            this.contacts.forEach(obj => {
              let subs = this.getSubs(obj['full_name'].toLowerCase());
              if (subs.indexOf(this.search.value.toLowerCase()) !== -1) {
                this.searchList.push(obj);
              }
            })
          } else {
            this.retrieveList();
          }
          if (this.searchList.length > 0) {
            this.renderList(this.searchList);
          } else {
            this.initial.style.display = 'block';
            document.querySelector('#all_tags').style.display = 'block';
            this.fullList.style.display = 'none';
          }
          //} else {
          //  this.retrieveList();
          //}

        },
        renderList(array) {
          this.initial.style.display = 'none';
          this.fullList.style.display = 'block';
          this.fullList.innerHTML = '';
          this.fullList.innerHTML = this.list_template({ array: array });
          document.querySelector('#all_tags').style.display = 'block';
        },
        renderTagList(e) {
          let selectedTag = e.target.textContent;
          if (selectedTag === 'sales') {
            this.sales_tags = this.getTags(selectedTag);
            this.renderList(this.sales_tags);
          } else if (selectedTag === 'marketing') {
            this.marketing_tags = this.getTags(selectedTag);
            this.renderList(this.marketing_tags);
          } else if (selectedTag === 'engineering') {
            this.engineering_tags = this.getTags(selectedTag);
            this.renderList(this.engineering_tags);
          }
        },

        success() {
          let success = document.createTextNode('Submitted successfully');
          let p = document.createElement('p');
          p.appendChild(success);
          document.querySelector('#add_search').appendChild(p);
        },
        getTags(tagName) {
          let tagsList = [];
          this.contacts.forEach(obj => {
            if (obj['tags'] instanceof Object) {
              if (obj['tags'].includes(tagName)) {
                tagsList.push(obj);
              }
            }
          })
          return tagsList;
        },
        getSubs(str) {
          let arr = str.split('');
          let subs = [];
          for (let i = 0; i < arr.length; i++) {
            for (let j = i + 1; j <= arr.length; j++) {
              subs.push(arr.slice(i, j).join(''));
            }
          }

          return subs.filter(sub => sub.trim());
        },
        formDataToJson(formData) {
          const json = {};
          //let tagsList = [];
          let tagsList = '';
          for (const pair of formData.entries()) {
            if (pair[0] === 'tags' && pair[1]) {
              //if (!tagsList.includes(pair[1])) {
              //  tagsList.push(pair[1])
              if (tagsList.indexOf(pair[1]) === -1) {
                tagsList.length > 0 ? tagsList += `,${pair[1]}` : tagsList += `${pair[1]}`;
              }
              continue;
            }
            json[pair[0]] = pair[1];
          }
          //json.tags = tagsList.split(',');
          json.tags = tagsList;
          return json;
        },
        init() {
          document.addEventListener('click', () => {
            let successNode = document.querySelectorAll('#add_search p');
            if (successNode) successNode.forEach(node => node.textContent = '');
          })
          //add buttons
          this.add_btn = document.querySelectorAll('.add_btn');
          this.add_btn.forEach(btn => btn.addEventListener('click', this.handleAdd.bind(this)));
          //submit new contact
          this.form_new = document.querySelector('#create_div form');
          this.form_new.addEventListener('submit', this.handleSubmitNew.bind(this));
          //submit edited + cancel
          this.form_div = document.querySelector('#form_div');
          this.form_div.addEventListener('click', e => {
            if (e.target.classList.contains('cancel')) { this.handleCancel(e) }
            else if (e.target.classList.contains('submit') && e.target.closest('#edit_div')) {
              this.handleSubmitEdit(e, e.target.parentNode.parentNode.id)
            }
          })
          //tags + edit/delete buttons
          this.fullList = document.querySelector('#list_populated');
          this.fullList.addEventListener('click', this.handleListClick.bind(this));

          //search box
          this.search = document.querySelector('#search');
          this.search.addEventListener('input', this.handleSearch.bind(this));

          //all contacts button
          document.querySelector('#all_tags').addEventListener('click', this.retrieveList.bind(this))

          //other variables declarations
          this.initial = document.querySelector('#list_initial');
          this.list_template = Handlebars.compile(document.querySelector('#list_template').innerHTML);
          this.edit_template = Handlebars.compile(document.querySelector('#edit_form_template').innerHTML);
          //how to enforce form field requirements in the edit form? why is it not working there? Alternative is to prevent a user from pressing the space key if the field is blank. And to prevent user from clicking backspace key when the value is just 1.
          //this.edit_form_template.addEventListener('input')
          this.searchQuery = null;
          this.searchList = [];
          this.contacts = [];
          this.sales_tags = [];
          this.marketing_tags = [];
          this.engineering_tags = [];

          this.retrieveList();
        }
      }
      App.init();
    })
  </script>
</body>

</html>
<!-- //do I put ELs for dynamically created elements in init method, i.e. the edit and delete buttons? And why can't i select the node representing the button of each contact created by the list_template? Answer to both is elements arent yet created before rendering using Handelbars template, so need to use event delegation
 -->
